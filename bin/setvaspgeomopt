#! /usr/bin/env ruby
# coding: utf-8

require "optparse"
require "fileutils"
require "rubygems"
require "comana"
require "vasputils"

## option analysis
OPTIONS = {}
op = OptionParser.new
op.on("-r", "--reset", "Remain 'try00' dir and 4 initial files."){OPTIONS[:reset] = true}
op.on("-n", "--next" , "Next vasp for geometry optimization."){OPTIONS[:next] = true}
op.on("-R", "--reincarnate", "Like recet, but generate 'try00' using final CONTCAR."){OPTIONS[:reincarnate] = true}
op.parse!(ARGV)

tgts = ARGV
tgts = [ENV['PWD']] if tgts.size == 0

#pp tgts; exit
#
def ask
  print "  Execute? [y/n]: "
  if OPTIONS[:yes]
    puts "-y option is indicated."
    return true
  end

  if OPTIONS[:no]
    puts "-n option is indicated."
    return false
  end

  /^y/i =~ $stdin.readline
end

tgts.each do |tgt_dir|
  puts "Directory: #{tgt_dir}"

  # Check tgt_dir is VaspDir?
  begin
    tgt = VaspUtils::VaspGeometryOptimizer.new(tgt_dir)
  rescue
    puts "  Not VaspGeometryOptimizer: #{tgt_dir}"
    next
  end

  puts "  Refresh VaspGeometryOptimizer: #{tgt_dir}"
  if OPTIONS[:reincarnate]
    tgt.reincarnate
  end
end
